# 概述
分布式存储系统的特点：**可扩展，低成本，高性能，易用**
主要技术：**数据分布，一致性，容错，负载均衡，事务与并发控制，易用性设计，压缩／解压缩**
1. 分布式文件系统
存储数据类型：**Blob（Binary Large Object），定长块，大文件**
2. 分布式健值系统
3. 分布式表格系统
4. 分布式数据库

## 单机存储
Hash表，B树在机械磁盘，SSD的实现就是单机存储引擎。
NUMA架构，每个节点是一个SMP结构，以网络链接
为避免网络拓扑结构的依赖，Google采用扁平拓扑结构，三级CLOS网络
先知道硬件的性能指标和价格，才能知道瓶颈，要用什么技术，解决那里的问题，比如硬盘的随机读写慢问题
SSD有写入放大问题（[Write amplification](https://zh.wikipedia.org/wiki/写入放大))，会影响其实际写入带宽

### Hash存储引擎
1. Bitcask 仅支持追加操作，文件写到固定大小后开新的文件，同一时刻只有一个新的文件，hash索引每个key对应的文件id，长度，偏移，以便于找到对应的value，对于删除，只修改value值为特殊值，不真的删除
2. 定期合并删除和被更新后的垃圾数据，生成新文件
3. 快速恢复，防止内存中的hash索引丢失，每次合并删除时，创建索引文件，相当于把内存中的索引dump到硬盘，恢复时直接读文件

### B树存储引擎
关系数据库以此为底层存储实现，支持随机存储和范围扫描，如InnoDb
数据库的缓存算法LIRS，把缓存分为两级，热点数据进入第二级，第一季采用LRU替换，防止全表扫描等操作使得缓存池中的大量页面被换出

### LSM树存储引擎
log Structured Merge Tree，把数据的修改增量缓存在内存中，批量操作磁盘。读取时合并磁盘和内存数据。
LevelDB，数据写入时，先写日志，然后写内存，内存满了，开一块新的继续写，写的操作不能被hold住。硬盘存的文件有顺序性，和一些索引信息，使得内存数据写入硬盘时性能好

### 数据模型
* 文件模型，对象模式弱化的文件模型，POSIX标准
* 关系模型，表格，SQL
* 键值模型，NoSql，put get delete

传统SQL数据库在海量数据场景面临的挑战：
1. 事务，ACID特性
2. 联表，违背第三范式，A表中存B表中的非主键信息
3. 性能

### 事务与并发控制
COW(Copy on Write) & MVCC(Muti-Version Concurrency Control)
可串行化：多个事务并发执行的结果，和按照某个顺序串行执行的结果相同
MVCC:以InnoDB为例，每一行存一个被修改的“时间”和删除的“时间”，这里的时间就是数据库的版本号，每次执行一个事务时，会在分配一个版本号给该事务，根据此事务号和每行的版本号比较，判断某一行是否该参与此事务。Update时，会先copy一份
故障恢复时纪录的日志，UNDO／REDO 顾名思义，简化日志的记法，批量刷日志到磁盘。定期dump数据，checkpoint技术。REDO日志纪录的都是修改后的结果，使得回放操作具有幂等性

### 压缩
LZ算法，后续的压缩都在此体系下，根据效率和压缩比例改进调整，以列存储实现OLAP数据库，提高压缩比例，减少查询时间

## 分布式系统
木桶原理 －> 发现短板 －> 性能估算
Paxos协议&两段提交协议
分布式系统的三态：成功，失败，超时，对于超时，要么操作幂等反复重试，要么获取刚才的操作状态，以此判断
越是强的一致性模型，使用越简单

### 性能分析
排序性能分析方法：排序时间＝比较时间（分支预测错误，5ns左右）＋ 内存访问时间（4GB/s 内存访问速度）
1GB 4字节整数快排约28s

### 数据分布
####Hash分布
* 对于大用户处理方式：
1. 手动拆分，定时跑任务，配置拆分规则
2. 自动拆分，由数据分布算法动态调整
* 机器变化时Hash的N值变化，数据要重新部署，解决：
1. 把hash和机器的映射元信息由专门的服务器管理而不是简单的模运算
2. 采用一致性Hash distributed hash table，给每个节点分配随机token，这些token构成hash环。先计算key的hash，然后放到顺时针第一个大于或等于此hash值的token所在的节点。有点，节点删除或增加时，只影响hash环中相邻节点。但还要考虑迁移执行时负载不均衡。每台节点都纪录所有的hash环的信息。
####顺序分布
需要考虑顺序数据表的分裂和合并

### 负载均衡
是个30-60分钟的慢过程，新节点加入时，master不可大量迁移数据到新机器

### 复制
强同步复制，异步复制
同步常用的做法是同步操作日志，副本上回放日志
除了主副本＋复制协议，还有写多个节点的复制协议，不分主副，一共N个，W个写副本，R个读副本，保证W＋R>N
